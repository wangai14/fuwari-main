---
import type { MarkdownHeading } from "astro";
import Categories from "./Categories.astro";
import Profile from "./Profile.astro";
import Tag from "./Tags.astro";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
}

const className = Astro.props.class;
---

<div id="sidebar" class:list={[className, "w-full"]}>
  <!-- 🧍 个人信息 -->
  <div class="flex flex-col w-full gap-4 mb-4">
    <Profile />

    <!-- 👁️ 浏览统计 -->
    <div class="flex items-center text-sm text-white/60 dark:text-white/40 mt-2 px-1">
      <svg class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none">
        <path
          d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5z"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <circle cx="12" cy="12" r="3" fill="currentColor" />
      </svg>
      <span id="sidebar-stats">统计加载中...</span>
    </div>
  </div>

  <!-- 📌 置顶内容 -->
  <div id="sidebar-sticky" class="transition-all duration-700 flex flex-col w-full gap-4 sticky top-4">
    <Categories class="onload-animation" style="animation-delay: 150ms" />
    <Tag class="onload-animation" style="animation-delay: 200ms" />

    <!-- ✅ 推广 iframe -->
    <iframe
      frameborder="0"
      src="https://support.nodeget.com/page/promotion?id=your_id"
      style="border-radius:8px; height: 270px;
            transform: scale(1.0); transform-origin: top left; width: 100%;">
    </iframe>
  </div>
</div>

<!-- 👁️ 浏览/访客统计脚本（Umami） -->
<script is:inline>
  window.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("https://cloud.umami.is/api/websites/dc8728b4-fa5e-4191-981a-ab2bcb0dee27/stats");
      if (!res.ok) throw new Error("Umami 请求失败");

      const data = await res.json();
      const views = data.pageviews ?? 0;
      const visitors = data.uniques ?? 0;
      document.getElementById("sidebar-stats").textContent =
        `浏览量 ${views.toLocaleString()} · 访问量 ${visitors.toLocaleString()}`;
    } catch (e) {
      document.getElementById("sidebar-stats").textContent = "统计加载错误";
      console.error("📊 Umami 加载失败：", e);
    }
  });
</script>
